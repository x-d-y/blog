---
title: mysql事务（三）
date: 2019-10-12 17:31:58
tags: mysql
---

&#160;&#160;&#160;&#160;&#160;&#160;
mysql事务具备ACID属性，即Atomicity、Consistency、Isolation和Durability。他们具体含义分别为：
- Atomicity(原子性):
  
  在mysql中，事务是由一组sql语句组成的执行指令，这些指令一条一条按照一定的顺序执行。如果某一条失败使得整个事务没有办法完整的完成，则要回滚到最初开始执行事务之前的状态。原子性保证了事务要么执行完成，要么不执行，不存在某个事务执行一半。
<!--more-->

- Consistency(一致性):

  一致性指事务将数据库从一种状态转变为下一种一致的状态。在事务开始和结束之后，数据库的完整性约束没有改变。例如，张三给李四转账一百元，整个过程看做是一个事务。对于外界而言，看到的只有两种状态，张三账户少一百且李四账户多一百。或者是张三账户没有变动，李四账户也没有变动。不论哪一种状态都遵循张三账户余额与李四账户余额和值不变。绝对不存在张三账户少一百元，李四账户余额不变的情况。简单通过一句话概括就是：指的是逻辑上的一致性，即所有操作是符合现实当中的期望的。
 
- Isolation(隔离性):

  两个同时发生的事务相互不干涉。事务A对数据的改变不能影响到事务B，反过来事务B对数据的改变不影响事务A。

- Durable(持久性):

  不论数据库在发生故障停止还是认为停止，或者数据库所在设备发生宕机，所有已经保存过的数据都存留在硬盘上。当重新启动数据库后，数据不丢失。

### 事务:

#### 事务的启动与结束：
```
启动事务：

START TRANSACTION;

或：

BEGIN;

结束事务(提交事务)：

COMMIT;

```

在默认状态下，mysql使用的是autocommit,即在输入一条sql语句后，自动开启事务并提交。

#### 事务的回滚:
```
回滚事务:

ROLLBACK;
```

#### 使用保存点:
```
例:

begin;

<transaction-part1>

savepoint <savePointName> //标记存储点

<transaction-part2>(error)

rollback to <savePointName> //回滚到存储点

commit;
```

### 事务的隔离级别:

#### 事务隔离级别-- read uncommitted
当A事务和B事务同时进行时，A事务对数据库某些数据进行修改，且A事务未提交。此时事务B能立刻查看到A未提到的修改数据。

#### 事务隔离级别-- read committed

当A事务和B事务在同时进行时，A事务对数据进行修改，B事务查看不到A事务修改过的数据，仅能查看A修改之前的数据。当A事务进行提交后，B事务方能看见A事务修改后的数据。

#### 事务隔离级别-- repeatable read

当A事务和B事务同时进行时，A事务不论做任何修改，提交与不提交。B事务始终查看不到A事务所做任何修改。虽然查看不到，但是B事务在修改和删除时会受到A事务的影响。

例： 

1.A新增一条数据并提交，B虽然查看不到该条数据，但是能对该条数据进行删除，当B提交成功后，A新增的数据被删除。

2.A新增一条数据并提交，B对该条数据不可见但能够进行修改，修改后B在事务内就能查看到该数据，当B提交后，全局可看见B修改后的数据。

#### 序列化:

通过把选定的所有行都锁起来，序列化可以提供最该级别的隔离。此级别与 REPEATABLE READ类似。

### 锁：

#### 内部锁：

##### 行级锁：

mysql最细粒度的锁，对某一条数据进行加锁，目前支持行级锁的数据库引擎只有InnoDB。

##### 表级锁:

一次值允许一个回话操作一张表，不支持两个会话同时对同一张表进行操作。

#### 外部锁：

外部锁使用 LOCK TABLE 和 UNLOCK TABLES语句来执行。又分为共享锁和排它锁:

##### 共享锁(读锁):

当一个表被READ锁所占据，多个会话仍然可以从该表读取数据也可以对该表重复添加读锁。但是不允读锁以外的锁进入。

##### 排它锁(写锁)：

当一个表被 WRITE锁所占据，拒绝任何其他的锁进入，拒绝任何会话读写该表。

