---
title: 利用云服务器实现从外网到内网的穿透
date: 2019-04-30 01:02:21
tags: 运维
---
&#160;&#160;&#160;&#160;&#160;&#160;
在现实生活中，很多能够联入互联网的设备可以主动访问其他联入互联网的设备，但该设备却很难被其他联入互联网的设备主动访问。最直接的原因就是该设备没有公网IP地址，难以被其他设备找到，所以无法被其他设备主动连接。但通常在生产环境中，我们需要对这些能够连入互联网却没有公网IP的设备进行访问和操作。本文将详细介绍如何使用具有公网IP地址的云服务器，对没有公网IP的设备进行访问。

## 公网IP与云服务器
&#160;&#160;&#160;&#160;&#160;&#160;
公网IP地址是暴露于广域互联网的IP地址，任何接入互联网的网络设备均可以通过公网IP地址，访问绑定于该公网IP地址的设备。云服务器作为一种可以通过公网IP访问的虚拟资源，可以在任何一台计算机上通过公网IP对其进行访问与操作。简单来说，云服务器是具有公网IP地址，可以通过互联网对其进行访问与操作的虚拟服务器。

## 通过云服务器主动访问内网设备的原理
通过云服务器访问内网设备可以分为两个部分：1.通过公网连接到云服务器；2.将被访问的内网设备和云服务器建立起连接并保持长连接，以便云服务器能够不断的向内网设备发送数据和接收数据。
<!--more-->
本文中所要介绍的方法是借助autossh来完成。在被访问的内网设备上运行autossh，并添加三个端口配置。它们分别是：1. 内网设备与云服务器保持长连接端口，通过该端口与云服务器进行数据传输；2.云服务器端的监听端口，实时与内网长连接端口保持连接，监听来自内网的数据以及向内网设备传输数据；3.云服务器的外部访问端口，该端口负责向监听端口收发数据。它们三个端口就构成了向内网穿透的框架。首先，一台联入互联网的外网设备向云服务器的外部访问端口发送数据，外部访问端口接收到数据后向监听端口转发数据，监听端口接收到数据后，向内网设备的长连接端口发送数据。反过来接收来自内网长连接端口的数据，并将其发送给外部访问端口，通过外部访问接口回传给外网设备。这样就完成了从外网设备向内网设备发送数据并接收数据的全过程。原理图如下图1所示。
<div align=center>
<img src="https://github.com/x-d-y/blog/blob/master/source/_posts/%E4%BD%BF%E7%94%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E8%AE%BE%E5%A4%87/autossh.png?raw=true" width = "500" >
</div>

## 操作流程
##### 内网被访问机器：
安装openssh服务，并配置端口，默认端口为22，但是考虑到安全性和端口占用，新配置一个能够通过ssh连接的2222端口。
```
打开sshd配置文件：
vim /etc/ssh/sshd_config
新增如下：
Port 2222
Port 22
Protocol 2
重启sshd服务，使配置生效：
systemctl restart sshd
```
配置免密登陆云服务器，使建立长连接的时候不需要密码。
```
生成密钥：
ssh-keygen -t 'rsa' -b '4096' -C 'xxx@xxx'
配置免密登陆：
ssh-copy-id user@xxx.xxx.xxx.xxx -p port
```
启动autossh。
```
autossh -p port1 -M port2 -fCNR 'serverIp:port3:localhost:port4' serverUser@serverIp -i ~/.ssh/id_rsa
#port1 登陆server的ssh端口
#port2 云服务器的监听端口
#port3 云服务器外部访问端口
#port4 内网设备长连接端口
#-f 静默运行
#-C 数据压缩
#-N 不执行任何命令
#-R 使用远程端口转发
# 该指令的含义为，通过port1，使用~/.ssh/id_rsa密钥免密远程登陆到云服务器。然后将云服务器port3端口收到的数据通过port2端口发送给内网设备的port4端口。实现从port3端口主动访问内网设备的目的。
```
查看服务状态：
```
ps aux|grep autossh
```
##### 云服务器：
修改sshd文件，打开网管端口使port3能够被访问。修改部分如下图2所示。
<div align=center>
 <img src="https://github.com/x-d-y/blog/blob/master/source/_posts/%E4%BD%BF%E7%94%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E8%AE%BE%E5%A4%87/autossh_server.png?raw=true" width = 300>
</div>
##### 通过公网访问内网设备：
```
ssh user@serverIp -p port3
```

## 总结：
本文主要介绍了如何利用拥有公网ip的云服务器，实现对内网设备的访问，并分析了技术原理和技术实现方法。其主要原理和方法为通过云服务器的外部访问接口接收数据，将数据转发到云服务器的监听端口上。然后将数据传送到内网设备的长连接端口上，从而实现从公网对内网设备的访问。



